# GitHub æ¯æ—¥è‡ªåŠ¨æäº¤å·¥ä½œæµ
# åŠŸèƒ½ï¼šæ¯å¤©è‡ªåŠ¨æäº¤ä¸€æ¬¡ï¼Œä¿æŒGitHubè´¡çŒ®å›¾çš„ç»¿è‰²
# é…ç½®ï¼šè¯·ä¿®æ”¹é¡¹ç›®æ ¹ç›®å½•ä¸‹çš„ config.yml æ–‡ä»¶

name: Daily Auto Commit

on:
  # æ¯å¤© UTC æ—¶é—´ 00:00 è¿è¡Œ (åŒ—äº¬æ—¶é—´ 08:00)
  schedule:
    - cron: '0 0 * * *'
  # æ”¯æŒæ‰‹åŠ¨è§¦å‘ï¼ˆç”¨äºæµ‹è¯•ï¼‰
  workflow_dispatch:

jobs:
  auto-commit:
    runs-on: ubuntu-latest
    
    steps:
      # æ­¥éª¤1: æ£€å‡ºä»“åº“ä»£ç 
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      # æ­¥éª¤2: ä»é…ç½®æ–‡ä»¶è¯»å–å¹¶é…ç½®Gitç”¨æˆ·ä¿¡æ¯
      - name: Configure Git User
        run: |
          # å®‰è£… yq ç”¨äºè§£æ YAML é…ç½®æ–‡ä»¶
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
          
          # ä» config.yml è¯»å–ç”¨æˆ·é…ç½®
          USER_NAME=$(yq '.git.user_name' config.yml)
          USER_EMAIL=$(yq '.git.user_email' config.yml)
          
          # é…ç½® Git
          git config user.name "$USER_NAME"
          git config user.email "$USER_EMAIL"
          
          echo "âœ… Git é…ç½®å®Œæˆ"
          echo "   ç”¨æˆ·å: $USER_NAME"
          echo "   é‚®ç®±: $USER_EMAIL"
      
      # æ­¥éª¤3: ç”Ÿæˆæäº¤å†…å®¹
      - name: Generate Commit Content
        run: |
          # è·å–å½“å‰æ—¶é—´ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
          TIMESTAMP=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')
          DATE=$(TZ='Asia/Shanghai' date '+%Y-%m-%d')
          
          # åˆ›å»ºæˆ–æ›´æ–°æ—¥å¿—æ–‡ä»¶
          echo "## ğŸ“… $TIMESTAMP" >> logs/daily-log.md
          echo "" >> logs/daily-log.md
          echo "- âœ… è‡ªåŠ¨æäº¤æˆåŠŸ" >> logs/daily-log.md
          echo "- ğŸ¤– ç”± GitHub Actions è‡ªåŠ¨æ‰§è¡Œ" >> logs/daily-log.md
          echo "" >> logs/daily-log.md
          echo "---" >> logs/daily-log.md
          echo "" >> logs/daily-log.md
          
          # æ›´æ–°æœ€åæäº¤æ—¶é—´æˆ³
          echo "$TIMESTAMP" > logs/last-commit.txt
          
          echo "âœ… æ—¥å¿—å†…å®¹å·²ç”Ÿæˆ"
      
      # æ­¥éª¤4: æäº¤å¹¶æ¨é€
      - name: Commit and Push
        run: |
          git add -A
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´éœ€è¦æäº¤
          if git diff --staged --quiet; then
            echo "âš ï¸ æ²¡æœ‰æ£€æµ‹åˆ°å˜æ›´ï¼Œè·³è¿‡æäº¤"
          else
            TIMESTAMP=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')
            git commit -m "ğŸ¤– Daily auto commit - $TIMESTAMP"
            git push
            echo "âœ… æäº¤å¹¶æ¨é€æˆåŠŸï¼"
          fi
